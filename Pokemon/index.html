<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Lumiose City Interactive Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        background: #111;
      }
      #map {
        width: 100%;
        height: 100%;
        border: 2px solid #333;
      }
      .panel {
        background: rgba(0, 0, 0, 0.75);
        color: #fff;
        padding: 12px;
        border-radius: 8px;
        font-family: sans-serif;
        font-size: 13px;
        line-height: 1.4em;
        user-select: none;
      }
      .panel label {
        display: block;
        margin-top: 6px;
      }
      .panel input,
      .panel select {
        width: 120px;
        padding: 3px 5px;
        margin-left: 4px;
      }
      .panel button {
        margin: 4px 2px;
        padding: 6px 12px;
        background: #444;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .panel button.active {
        background: #0a84ff;
      }
      .colorInput {
        width: 40px;
        padding: 0;
        border: none;
        cursor: pointer;
      }
      .panel small {
        font-size: 11px;
        color: #ccc;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      /**************************************************
       * MAP CONFIG
       **************************************************/
      const IMAGE_URL = "Lumiose_City_Day.png";
      const IMAGE_WIDTH_PX = 2000;
      const IMAGE_HEIGHT_PX = 2000;
      const PIXELS_PER_UNIT = 1.975; // your calibrated scale

      const MAP_WIDTH_UNITS = IMAGE_WIDTH_PX / PIXELS_PER_UNIT;
      const MAP_HEIGHT_UNITS = IMAGE_HEIGHT_PX / PIXELS_PER_UNIT;

      const SNAP_SIZE_UNITS = 0.5; // very fine snap-to-grid

      let radius1 = 50; // blue circle
      let radius2 = 70; // red circle
      let customMarkers = [];

      let map, origin, originMarker, circle1, circle2, activeLine;

      // global state for modes
      let mode = "measure";
      let addPointMode = false;
      let newMarkerColor = "#00ff00";
      let newMarkerLabel = "Custom Point";
      let newMarkerType = "circle";
      let markersLocked = false;

      // layer groups for toggling
      let circlesLayer, benchesLayer, laddersLayer, elevatorsLayer;

      // UI refs (filled in buildMap)
      let ui = {};

      /**************************************************
       * SVG ICONS (Bench, Ladder, Elevator)
       **************************************************/
      const ICONS = {
        circle: (color) => `
    <div style="width:18px;height:18px;border-radius:50%;background:${color};
         border:2px solid #000;"></div>
  `,
        bench: `
    <svg width="24" height="24" viewBox="0 0 24 24">
      <rect x="2" y="10" width="20" height="4" fill="#b0793c" stroke="#000" stroke-width="1"/>
      <rect x="2" y="6" width="20" height="4" fill="#d08c43" stroke="#000" stroke-width="1"/>
      <rect x="4" y="14" width="2" height="6" fill="#7a4e21"/>
      <rect x="18" y="14" width="2" height="6" fill="#7a4e21"/>
    </svg>
  `,
        ladder: `
    <svg width="24" height="24" viewBox="0 0 24 24">
      <rect x="7" y="3" width="3" height="18" fill="#c0c0c0" stroke="#000" stroke-width="1"/>
      <rect x="14" y="3" width="3" height="18" fill="#c0c0c0" stroke="#000" stroke-width="1"/>
      <rect x="7" y="6" width="10" height="2" fill="#999" stroke="#000" stroke-width="1"/>
      <rect x="7" y="10" width="10" height="2" fill="#999" stroke="#000" stroke-width="1"/>
      <rect x="7" y="14" width="10" height="2" fill="#999" stroke="#000" stroke-width="1"/>
      <rect x="7" y="18" width="10" height="2" fill="#999" stroke="#000" stroke-width="1"/>
    </svg>
  `,
        elevator: `
    <svg width="24" height="24" viewBox="0 0 24 24">
      <rect x="4" y="4" width="16" height="16" fill="#bbbbbb" stroke="#000" stroke-width="1"/>
      <polygon points="8,10 12,6 16,10" fill="#333"/>
      <polygon points="8,14 12,18 16,14" fill="#333"/>
    </svg>
  `,
      };

      /**************************************************
       * INITIALIZE MAP
       **************************************************/
      function buildMap() {
        if (map) {
          map.off();
          map.remove();
        }

        const bounds = [
          [0, 0],
          [MAP_HEIGHT_UNITS, MAP_WIDTH_UNITS],
        ];
        map = L.map("map", {
          crs: L.CRS.Simple,
          minZoom: -1,
          maxZoom: 4,
          zoomSnap: 0.25,
          zoomDelta: 0.25,
        });

        L.imageOverlay(IMAGE_URL, bounds).addTo(map);
        map.fitBounds(bounds);
        map.setMaxBounds(bounds);

        // layer groups for marker types
        circlesLayer = L.layerGroup().addTo(map);
        benchesLayer = L.layerGroup().addTo(map);
        laddersLayer = L.layerGroup().addTo(map);
        elevatorsLayer = L.layerGroup().addTo(map);

        origin = [MAP_HEIGHT_UNITS / 2, MAP_WIDTH_UNITS / 2];

        /***********************************************
         * DRAGGABLE ORIGIN MARKER
         ***********************************************/
        originMarker = L.marker(origin, { draggable: true }).addTo(map);
        circle1 = L.circle(origin, {
          radius: radius1,
          color: "rgba(0,150,255,0.9)",
          fill: false,
        }).addTo(map);
        circle2 = L.circle(origin, {
          radius: radius2,
          color: "rgba(255,100,100,0.8)",
          fill: false,
        }).addTo(map);

        originMarker.on("drag", (e) => {
          const p = e.target.getLatLng();
          circle1.setLatLng(p);
          circle2.setLatLng(p);
        });

        originMarker.on("dragend", (e) => {
          origin = [e.target.getLatLng().lat, e.target.getLatLng().lng];
        });

        /***********************************************
         * MAP CLICK LOGIC
         ***********************************************/
        map.on("click", (e) => {
          if (isClickOnPanel) return;

          const rawPoint = [e.latlng.lat, e.latlng.lng];

          if (addPointMode) {
            const snapped = snapToGrid(rawPoint);
            addCustomMarker(
              snapped,
              newMarkerLabel,
              newMarkerColor,
              newMarkerType
            );
            return;
          }
          if (mode === "measure") measureTo(rawPoint);
        });

        /***********************************************
         * CONTROL PANEL UI
         ***********************************************/
        const panel = L.control({ position: "topright" });
        panel.onAdd = () => {
          const div = L.DomUtil.create("div", "panel");

          div.innerHTML = `
      <strong>Map Controls</strong><br>
      <button id="measureBtn" class="active">Measure</button>
      <button id="addPointBtn">Add Point</button>

      <hr style="border-color:#555">

      <label>Scale: <b>${PIXELS_PER_UNIT}</b> px/unit</label>
      <label>Blue Radius: <input id="r1Input" type="number" value="${radius1}"></label>
      <label>Red Radius: <input id="r2Input" type="number" value="${radius2}"></label>
      <button id="applyBtn">Apply</button>

      <hr style="border-color:#555">

      <strong>Custom Point Settings</strong>
      <label>Label: <input id="labelInput" type="text" value="Custom Point"></label>

      <label>Icon Type:
        <select id="iconType">
          <option value="circle">Colored Circle</option>
          <option value="bench">Bench</option>
          <option value="ladder">Ladder</option>
          <option value="elevator">Elevator</option>
        </select>
      </label>

      <label>Color (circle only):
        <input id="colorInput" class="colorInput" type="color" value="#00ff00">
      </label>

      <hr style="border-color:#555">

      <strong>Marker Layers</strong>
      <label><input type="checkbox" id="toggleCircles" checked> Show Circles</label>
      <label><input type="checkbox" id="toggleBenches" checked> Show Benches</label>
      <label><input type="checkbox" id="toggleLadders" checked> Show Ladders</label>
      <label><input type="checkbox" id="toggleElevators" checked> Show Elevators</label>

      <hr style="border-color:#555">

      <label><input type="checkbox" id="lockMarkers"> Lock markers (no drag)</label>
      <small>Origin marker is always draggable.</small>

      <hr style="border-color:#555">
      <small><b>Shortcuts:</b> 1=Bench, 2=Ladder, 3=Elevator, 4=Circle, M=Measure, P=Add Point</small>
    `;

          L.DomEvent.disableClickPropagation(div);
          return div;
        };
        panel.addTo(map);

        /***********************************************
         * CONNECT PANEL INPUTS
         ***********************************************/
        const p = document.querySelector(".panel");
        const measureBtn = p.querySelector("#measureBtn");
        const addPointBtn = p.querySelector("#addPointBtn");
        const r1Input = p.querySelector("#r1Input");
        const r2Input = p.querySelector("#r2Input");
        const applyBtn = p.querySelector("#applyBtn");
        const labelInput = p.querySelector("#labelInput");
        const colorInput = p.querySelector("#colorInput");
        const iconTypeSelect = p.querySelector("#iconType");

        const toggleCircles = p.querySelector("#toggleCircles");
        const toggleBenches = p.querySelector("#toggleBenches");
        const toggleLadders = p.querySelector("#toggleLadders");
        const toggleElevators = p.querySelector("#toggleElevators");
        const lockCheckbox = p.querySelector("#lockMarkers");

        // store UI refs for keyboard shortcuts
        ui = {
          measureBtn,
          addPointBtn,
          iconTypeSelect,
          labelInput,
          colorInput,
          r1Input,
          r2Input,
          toggleCircles,
          toggleBenches,
          toggleLadders,
          toggleElevators,
          lockCheckbox,
        };

        measureBtn.onclick = () => {
          mode = "measure";
          addPointMode = false;
          setActive(measureBtn);
        };
        addPointBtn.onclick = () => {
          mode = "none";
          addPointMode = true;
          setActive(addPointBtn);
        };

        applyBtn.onclick = () => {
          radius1 = parseFloat(r1Input.value);
          radius2 = parseFloat(r2Input.value);
          circle1.setRadius(radius1);
          circle2.setRadius(radius2);
        };

        labelInput.oninput = (e) => (newMarkerLabel = e.target.value);
        colorInput.oninput = (e) => (newMarkerColor = e.target.value);
        iconTypeSelect.onchange = (e) => (newMarkerType = e.target.value);

        // layer visibility
        toggleCircles.onchange = (e) => {
          if (e.target.checked) map.addLayer(circlesLayer);
          else map.removeLayer(circlesLayer);
        };
        toggleBenches.onchange = (e) => {
          if (e.target.checked) map.addLayer(benchesLayer);
          else map.removeLayer(benchesLayer);
        };
        toggleLadders.onchange = (e) => {
          if (e.target.checked) map.addLayer(laddersLayer);
          else map.removeLayer(laddersLayer);
        };
        toggleElevators.onchange = (e) => {
          if (e.target.checked) map.addLayer(elevatorsLayer);
          else map.removeLayer(elevatorsLayer);
        };

        // lock / unlock dragging
        lockCheckbox.onchange = (e) => {
          markersLocked = e.target.checked;
          customMarkers.forEach((m) => {
            if (!m || !m.dragging) return;
            if (markersLocked) m.dragging.disable();
            else m.dragging.enable();
          });
        };

        window.isClickOnPanel = false;
        p.addEventListener("mouseenter", () => (isClickOnPanel = true));
        p.addEventListener("mouseleave", () => (isClickOnPanel = false));

        function setActive(btn) {
          [measureBtn, addPointBtn].forEach((b) =>
            b.classList.remove("active")
          );
          btn.classList.add("active");
        }

        // keyboard shortcuts
        document.addEventListener("keydown", onKeyDown);
      }

      /**************************************************
       * HELPERS
       **************************************************/
      function snapToGrid(pt) {
        const s = SNAP_SIZE_UNITS;
        return [Math.round(pt[0] / s) * s, Math.round(pt[1] / s) * s];
      }

      function onKeyDown(e) {
        // ignore when typing in inputs
        const tag =
          document.activeElement && document.activeElement.tagName
            ? document.activeElement.tagName
            : "";
        if (["INPUT", "SELECT", "TEXTAREA", "BUTTON"].includes(tag)) return;

        if (!map) return;

        switch (e.key) {
          case "1": // bench
            newMarkerType = "bench";
            if (ui.iconTypeSelect) ui.iconTypeSelect.value = "bench";
            break;
          case "2": // ladder
            newMarkerType = "ladder";
            if (ui.iconTypeSelect) ui.iconTypeSelect.value = "ladder";
            break;
          case "3": // elevator
            newMarkerType = "elevator";
            if (ui.iconTypeSelect) ui.iconTypeSelect.value = "elevator";
            break;
          case "4": // circle
            newMarkerType = "circle";
            if (ui.iconTypeSelect) ui.iconTypeSelect.value = "circle";
            break;
          case "m":
          case "M":
            mode = "measure";
            addPointMode = false;
            if (ui.measureBtn && ui.addPointBtn) {
              ui.measureBtn.classList.add("active");
              ui.addPointBtn.classList.remove("active");
            }
            break;
          case "p":
          case "P":
            mode = "none";
            addPointMode = true;
            if (ui.measureBtn && ui.addPointBtn) {
              ui.measureBtn.classList.remove("active");
              ui.addPointBtn.classList.add("active");
            }
            break;
          default:
            break;
        }
      }

      /**************************************************
       * FUNCTIONS
       **************************************************/
      function measureTo(pt) {
        if (activeLine) map.removeLayer(activeLine);

        const du = Math.sqrt(
          (pt[0] - origin[0]) ** 2 + (pt[1] - origin[1]) ** 2
        );
        const dp = du * PIXELS_PER_UNIT;

        activeLine = L.polyline([origin, pt], {
          color: "lime",
          dashArray: "5,5",
        }).addTo(map);

        L.popup()
          .setLatLng(pt)
          .setContent(
            `
    <b>Distance:</b><br>
    ${du.toFixed(2)} units<br>
    ${dp.toFixed(0)} px
  `
          )
          .openOn(map);
      }

      let benchCount = 0;
      let ladderCount = 0;
      let elevatorCount = 0;

      function addCustomMarker(coords, label, color, type) {
        // Auto-name logic
        if (type === "bench") {
          benchCount++;
          label =
            label.trim() === "Custom Point" ? `Bench #${benchCount}` : label;
        } else if (type === "ladder") {
          ladderCount++;
          label =
            label.trim() === "Custom Point" ? `Ladder #${ladderCount}` : label;
        } else if (type === "elevator") {
          elevatorCount++;
          label =
            label.trim() === "Custom Point"
              ? `Elevator #${elevatorCount}`
              : label;
        } // circle keeps custom label

        // Build icon HTML
        let html;
        if (type === "circle") {
          html = ICONS.circle(color);
        } else {
          html = ICONS[type];
        }

        // Choose layer group
        let targetLayer = circlesLayer;
        if (type === "bench") targetLayer = benchesLayer;
        else if (type === "ladder") targetLayer = laddersLayer;
        else if (type === "elevator") targetLayer = elevatorsLayer;

        const index = customMarkers.length;

        const icon = L.divIcon({
          className: "",
          html: `<div style="width:24px;height:24px;">${html}</div>`,
          iconAnchor: [12, 12],
        });

        const marker = L.marker(coords, {
          icon,
          draggable: !markersLocked,
          autoPan: true,
        }).addTo(targetLayer);

        marker._markerLabel = label;
        marker._markerType = type;

        marker.bindPopup(`
    <b>${label}</b><br>
    <button onclick="editMarkerLabel(${index})">Edit Label</button>
    <button onclick="deleteMarker(${index})">Delete</button>
  `);

        customMarkers.push(marker);
      }

      window.deleteMarker = (idx) => {
        const m = customMarkers[idx];
        if (m) {
          map.removeLayer(m);
          customMarkers[idx] = null;
        }
      };

      window.editMarkerLabel = (idx) => {
        const m = customMarkers[idx];
        if (!m) return;
        const current = m._markerLabel || "Label";
        const updated = prompt("Edit label:", current);
        if (updated === null) return;
        const finalLabel = updated.trim() || current;
        m._markerLabel = finalLabel;

        m.bindPopup(
          `
    <b>${finalLabel}</b><br>
    <button onclick="editMarkerLabel(${idx})">Edit Label</button>
    <button onclick="deleteMarker(${idx})">Delete</button>
  `
        ).openPopup();
      };

      /**************************************************
       * START
       **************************************************/
      buildMap();
    </script>
  </body>
</html>
