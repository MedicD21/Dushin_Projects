<!DOCTYPE html>
<html>
  <head>
    <title>Lumiose Map Editor</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
      #map {
        width: 100vw;
        height: 100vh;
        background: #333;
        position: relative;
        user-select: none;
      }
      #map img {
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
      }
      .marker {
        width: 26px;
        height: 26px;
        position: absolute;
        cursor: grab;
        transform: translate(-50%, -50%);
        z-index: 10;
      }
      #ui {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 200;
        background: rgba(0, 0, 0, 0.5);
        padding: 10px;
        border-radius: 8px;
        color: white;
      }
      button {
        padding: 6px 10px;
        margin: 3px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      #contextMenu {
        position: absolute;
        display: none;
        background: white;
        border: 1px solid #666;
        border-radius: 4px;
        z-index: 300;
      }
      #contextMenu div {
        padding: 6px 10px;
        cursor: pointer;
      }
      #contextMenu div:hover {
        background: #eee;
      }
    </style>
  </head>
  <body>
    <div id="ui">
      <button onclick="exportMarkers()">Export Markers JSON</button>
    </div>

    <div id="map">
      <img id="baseMap" src="lumiose_resized_clean.png" />
    </div>

    <div id="contextMenu">
      <div onclick="changeType('bench')">Set to Bench</div>
      <div onclick="changeType('ladder')">Set to Ladder</div>
      <div onclick="changeType('elevator')">Set to Elevator</div>
      <div onclick="deleteMarker()">Delete Marker</div>
    </div>

    <script>
      let markers = [];
      let selectedMarker = null;
      let map = document.getElementById("map");
      let contextMenu = document.getElementById("contextMenu");
      let mapImg = document.getElementById("baseMap");

      const ICONS = {
        bench: "icon_bench.png",
        ladder: "icon_ladder.png",
        elevator: "icon_arrow.png",
      };

      async function loadMarkers() {
        let res = await fetch("markers.json");
        let data = await res.json();
        markers = data;
        data.forEach((m) => renderMarker(m));
      }

      function renderMarker(m) {
        let el = document.createElement("img");
        el.src = ICONS[m.type];
        el.className = "marker";
        el.style.left = m.clean_x + "px";
        el.style.top = m.clean_y + "px";
        el.dataset.id = m.id;

        el.onmousedown = startDrag;
        el.oncontextmenu = openMenu;

        map.appendChild(el);
      }

      function startDrag(e) {
        e.preventDefault();
        let el = e.target;
        selectedMarker = getMarkerById(el.dataset.id);

        let offsetX = e.clientX - parseInt(el.style.left);
        let offsetY = e.clientY - parseInt(el.style.top);

        function move(ev) {
          el.style.left = ev.clientX - offsetX + "px";
          el.style.top = ev.clientY - offsetY + "px";

          selectedMarker.clean_x = ev.clientX - offsetX;
          selectedMarker.clean_y = ev.clientY - offsetY;
        }
        function stop() {
          window.removeEventListener("mousemove", move);
          window.removeEventListener("mouseup", stop);
        }

        window.addEventListener("mousemove", move);
        window.addEventListener("mouseup", stop);
      }

      function openMenu(e) {
        e.preventDefault();
        selectedMarker = getMarkerById(e.target.dataset.id);
        contextMenu.style.left = e.pageX + "px";
        contextMenu.style.top = e.pageY + "px";
        contextMenu.style.display = "block";
      }

      window.onclick = () => (contextMenu.style.display = "none");

      function changeType(newType) {
        selectedMarker.type = newType;
        let el = document.querySelector(`img[data-id='${selectedMarker.id}']`);
        el.src = ICONS[newType];
        contextMenu.style.display = "none";
      }

      function deleteMarker() {
        document.querySelector(`img[data-id='${selectedMarker.id}']`).remove();
        markers = markers.filter((m) => m.id !== selectedMarker.id);
        contextMenu.style.display = "none";
      }

      map.addEventListener("click", function (e) {
        if (e.target !== mapImg) return;

        let id = crypto.randomUUID();
        let m = {
          id,
          type: "bench",
          clean_x: e.offsetX,
          clean_y: e.offsetY,
          ble_x: null,
          ble_y: null,
        };
        markers.push(m);
        renderMarker(m);
      });

      function exportMarkers() {
        let blob = new Blob([JSON.stringify(markers, null, 2)], {
          type: "application/json",
        });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "markers.json";
        a.click();
      }

      function getMarkerById(id) {
        return markers.find((m) => m.id === id);
      }

      loadMarkers();
    </script>
  </body>
</html>
